rules_version = '2';

// Craft rules based on data in your Firestore database
// allow write: if firestore.get(
//    /databases/(default)/documents/users/$(request.auth.uid)).data.isAdmin;
service firebase.storage {
  match /b/{bucket}/o {
    function isMasterActive() {
      return request.auth != null
        && request.auth.token.role == "master"
        && (request.auth.token.status == "active" || request.auth.token.status == "approved");
    }

    function isManager() {
      return request.auth != null && request.auth.token.role == "manager";
    }

    function isManagerProfile(uid) {
      return request.auth != null
        && request.auth.uid == uid
        && firestore.get(/databases/(default)/documents/users/$(uid)).data.role == "manager"
        && (firestore.get(/databases/(default)/documents/users/$(uid)).data.status == "pending"
          || firestore.get(/databases/(default)/documents/users/$(uid)).data.status == "active");
    }

    match /public/funds/{allPaths=**} {
      allow read: if true;
      allow write: if isMasterActive();
    }

    match /private/fundApplications/{uid}/{applicationId}/{allPaths=**} {
      allow read, write: if isMasterActive()
        || (isManager()
          && request.auth.uid == uid
          && (request.auth.token.status == "pending" || request.auth.token.status == "active"))
        || isManagerProfile(uid);
    }

    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
